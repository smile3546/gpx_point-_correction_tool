# GPX 路線處理與編輯工具

這是一個專門處理登山路線 GPX 軌跡的完整工具集，提供路線處理、編輯、切分和轉換等多項功能，適用於登山路線的數位化管理和分析。

## 主要功能

### 路線編輯界面 (frontend/)
- **互動式地圖編輯**：使用 Leaflet 地圖庫提供直觀的路線編輯介面
- **雙路線支援**：支援路線 A 和路線 B 的切換顯示和獨立編輯
- **點位管理功能**：新增、刪除和編輯點位資料，支援通訊點和 GPX 軌跡點
- **表格式檢視**：提供點位表格檢視、排序和搜尋功能
- **即時檔案下載**：支援下載修改後的 TXT 和 GeoJSON 檔案
- **動態路線掃描**：自動偵測 `data_work/` 資料夾中的所有可用路線

### GPX 檔案瀏覽界面 (網頁瀏覽/)
- **檔案瀏覽器**：專門瀏覽 `修改好的gpx/` 資料夾中的 GPX 檔案
- **完整檔案資訊**：顯示檔案統計資訊包括點位數量、路線長度等
- **互動式地圖顯示**：視覺化顯示完整路線軌跡和重要點位
- **詳細點位表格**：包含時間、海拔、座標等完整資訊
- **點位定位**：點擊表格行可跳轉到地圖對應位置

### 核心路線處理工具 (pt_process.py)
- **GPX 軌跡解析**：完整解析 GPX 檔案並保留時間戳記資訊
- **通訊點整合**：將 TXT 格式的通訊點資料整合到路線軌跡中
- **智能路徑投影**：確保通訊點投影到最近的軌跡路徑上
- **自動插值功能**：
  - 基於地理距離比例的線性插值演算法
  - 時間插值：根據相鄰點位計算缺失的時間資料
  - 高度插值：根據地形變化計算缺失的海拔資料
- **路線分割**：根據最後通訊點自動分割成往返路線（A/B）

### 路線切分工具 (route_splitter.py)
- **段落式切分**：依據通訊點順序將完整路線切分為多個段落
- **多格式輸出**：同時生成 TXT 和 GeoJSON 格式的切分檔案
- **分層資料結構**：自動建立 `route_a/route_b` → `geojson/txt` → `路線名稱` 的目錄結構
- **完整資料保留**：每個段落保留完整的點位屬性和時間資訊
- **插值前處理**：切分前自動執行資料插值確保完整性

### GeoJSON 轉 GPX 工具 (geojson_to_gpx.py)
- **批次轉換**：自動掃描並轉換所有 `data_work/` 中的路線
- **標準 GPX 格式**：輸出符合 GPX 1.1 標準的檔案
- **航點生成**：自動為通訊點建立 GPX 航點標記
- **資料完整性**：轉換前執行插值確保所有軌跡點都有時間和高度
- **檔名規範**：使用 `路線名稱_route_a.gpx` 格式命名

## 專案檔案結構

```
gpx_point-_correction_tool/
├── data_raw/                    # 原始輸入資料
│   ├── gpx/                     # 原始 GPX 軌跡檔案
│   └── txt/                     # 通訊點座標檔案（制表符分隔）
├── data_work/                   # 處理後的完整路線資料
│   ├── route_a/                 # 路線 A（去程或主要路線）
│   └── route_b/                 # 路線 B（回程或替代路線）
│       └── [路線名稱]/
│           ├── points.txt       # 完整點位清單
│           └── route.geojson    # 路線軌跡資料
├── 路線切分/                     # 按段落切分的路線資料
│   ├── route_a/                 # 路線 A 的切分資料
│   └── route_b/                 # 路線 B 的切分資料
│       ├── geojson/[路線名稱]/   # GeoJSON 格式段落檔案
│       └── txt/[路線名稱]/       # TXT 格式段落檔案
├── 最終json_txt/                # 歷史處理結果（舊版資料結構）
│   ├── 1.切分過的路線/           # 按段落分割的路線檔案
│   ├── 2.往前重複的geojson/      # 來回路線的 GeoJSON 檔案
│   └── 3.往前重複的txt/          # 來回路線的 TXT 檔案
├── 已改好的txt_geojson/         # 手動編輯過的路線資料
│   └── [路線名稱]/
│       ├── points.txt          # 編輯後的點位檔案
│       └── route.geojson       # 編輯後的路線檔案
├── 修改好的gpx/                  # 最終輸出的 GPX 檔案
│   ├── [路線名稱]_route_a.gpx    # 路線 A 的標準 GPX 檔案
│   └── [路線名稱]_route_b.gpx    # 路線 B 的標準 GPX 檔案
├── frontend/                    # 路線編輯網頁介面
│   ├── index.html              # 編輯工具主頁面
│   ├── main.js                 # 互動式編輯邏輯
│   └── style.css               # 介面樣式設定
├── 網頁瀏覽/                     # GPX 檔案瀏覽介面
│   ├── index.html              # 瀏覽工具主頁面
│   ├── main.js                 # 檔案瀏覽邏輯
│   └── style.css               # 瀏覽介面樣式
├── scripts/                     # 核心處理程式
│   ├── pt_process.py           # 主要路線處理與整合程式
│   ├── route_splitter.py       # 路線按段落切分程式
│   ├── geojson_to_gpx.py       # 格式轉換程式
│   ├── utils.py                # 共用工具函數庫
│   └── update_route_api.py     # 路線資料更新 API
└── 兩座山/                      # 特定路線的分析資料
    ├── *.csv                   # 聚類分析結果
    ├── filter_gpx_files.py     # GPX 檔案過濾工具
    └── index.html              # 專用瀏覽介面
```

## 完整使用流程

### 階段一：資料準備與初始處理

#### 步驟 1：準備原始資料 (data_raw/)
1. 將原始 GPX 軌跡檔案放入 `data_raw/gpx/` 資料夾
2. 將對應的通訊點 TXT 檔案放入 `data_raw/txt/` 資料夾
3. **重要**：確保 GPX 和 TXT 檔案使用相同的檔案名稱
   - 例如：`mt_jade_main.gpx` 和 `mt_jade_main.txt`

#### 步驟 2：執行路線處理 (pt_process.py)
```bash
cd scripts
python pt_process.py
```
**處理功能**：
- 解析 GPX 軌跡並保留完整時間資訊
- 整合通訊點資料到軌跡路徑中
- 執行智能插值補齊缺失的時間和高度資料
- 根據最後通訊點自動分割成路線 A 和路線 B
- 輸出完整路線資料到 `data_work/` 資料夾

### 階段二：路線編輯與精修

#### 步驟 3：使用路線編輯界面 (frontend/)
1. 開啟 `frontend/index.html`（建議使用本地伺服器）
2. **編輯功能**：
   - 在地圖上視覺化檢視完整路線
   - 切換檢視路線 A 和路線 B
   - 新增、刪除或修改點位資料
   - 調整點位順序和屬性
   - 即時下載修改後的檔案

#### 步驟 4：路線切分處理 (route_splitter.py)
```bash
python route_splitter.py
```
**切分功能**：
- 讀取通訊點資料並按順序切分路線
- 每段包含起點到終點間的所有軌跡點
- 生成 TXT 和 GeoJSON 雙格式檔案
- 建立結構化的資料夾分類
- 輸出到 `路線切分/` 資料夾

### 階段三：成果檢視與輸出

#### 步驟 5：檢視切分結果（可選）
1. 開啟 `網頁瀏覽/index.html`
2. **瀏覽功能**：
   - 選擇特定 GPX 檔案進行檢視
   - 查看完整的檔案統計資訊
   - 檢視詳細的點位資料表格
   - 在地圖上定位特定點位

#### 步驟 6：生成最終 GPX 檔案 (geojson_to_gpx.py)
```bash
python geojson_to_gpx.py
```
**輸出功能**：
- 批次轉換所有 `data_work/` 中的路線
- 生成標準 GPX 1.1 格式檔案
- 自動建立通訊點航點標記
- 確保所有軌跡點都有完整的時間和高度資料
- 輸出到 `修改好的gpx/` 資料夾

### 工作流程圖解

```
原始 GPX/TXT → pt_process.py → data_work/ → frontend/ → route_splitter.py → 路線切分/ → geojson_to_gpx.py → 修改好的gpx/
     ↓              ↓               ↓           ↓              ↓              ↓                 ↓
   原始資料      完整路線整合      編輯精修     段落切分       成果檢視        標準 GPX 輸出
```

## 支援的檔案格式

### 輸入格式規範

#### GPX 檔案 (.gpx)
- **標準**：GPX 1.1 格式
- **必要欄位**：軌跡點座標（緯度、經度）
- **可選欄位**：海拔高度、時間戳記
- **編碼**：UTF-8
- **內容**：完整的登山軌跡路徑

#### 通訊點檔案 (.txt)
- **格式**：制表符分隔值（TSV）
- **必要欄位**：緯度、經度、通訊點名稱
- **可選欄位**：海拔高度、備註資訊
- **編碼**：UTF-8
- **範例格式**：
  ```
  緯度	經度	海拔（約）	通訊點名稱
  24.123456	121.123456	3000	登山口
  ```

### 輸出格式規範

#### GeoJSON 檔案 (.geojson)
- **標準**：RFC 7946 GeoJSON 格式
- **幾何類型**：LineString（路線）和 Point（點位）
- **屬性**：完整的點位資訊和路線屬性
- **座標系統**：WGS84 (EPSG:4326)

#### TXT 檔案 (.txt)
- **格式**：制表符分隔，包含完整點位清單
- **欄位**：順序、緯度、經度、海拔、點位類型、名稱、時間
- **編碼**：UTF-8

#### GPX 檔案 (.gpx)
- **標準**：GPX 1.1 格式
- **軌跡點**：包含完整的時間、座標和海拔資訊
- **航點**：重要通訊點標記
- **檔名格式**：`路線名稱_route_a.gpx`

## 技術架構與規格

### 核心技術棧
- **後端處理**：Python 3.7+
  - GeoPandas：地理資料處理
  - Pandas：資料分析和操作
  - gpxpy：GPX 檔案解析
  - Shapely：幾何運算
- **前端界面**：HTML5 + JavaScript ES6
  - Leaflet：互動式地圖顯示
  - DataTables：表格資料管理
  - jQuery：DOM 操作和 AJAX

### 演算法與計算
- **距離計算**：Haversine 公式（地球表面距離）
- **插值演算法**：基於地理距離比例的線性插值
- **路徑投影**：最近點搜尋和路徑投影演算法
- **座標系統**：WGS84 經緯度座標系 (EPSG:4326)

### 資料處理特性
- **檔案編碼**：統一使用 UTF-8 確保中文相容性
- **時間處理**：ISO 8601 格式時間戳記
- **精度設定**：座標精度至小數點後 6 位
- **容錯機制**：自動處理缺失資料和格式異常

## 使用注意事項

### 檔案準備要求
1. **命名一致性**：GPX 和 TXT 檔案必須使用完全相同的檔案名稱
2. **檔案完整性**：確保 GPX 檔案包含有效的軌跡點資料
3. **座標精確性**：通訊點座標應儘量接近實際軌跡路徑
4. **資料備份**：處理前建議備份所有原始檔案

### 效能考量
- **檔案大小**：建議單一 GPX 檔案不超過 50MB
- **點位數量**：建議單一路線不超過 10,000 個軌跡點
- **處理時間**：複雜路線處理可能需要數分鐘
- **記憶體使用**：確保系統有足夠記憶體處理大型檔案

### 瀏覽器相容性
- **建議瀏覽器**：Chrome 80+、Firefox 75+、Safari 13+、Edge 80+
- **本地伺服器**：建議使用 HTTP 伺服器開啟 HTML 檔案，避免 CORS 問題
- **JavaScript 支援**：需要啟用 JavaScript 和本地檔案存取權限

## 常見問題與解決方案

### 資料處理問題

#### 問題：插值結果不準確
**原因**：GPX 軌跡點間距過大或時間資料不連續
**解決方案**：
1. 檢查原始 GPX 檔案的軌跡點密度
2. 確認時間戳記的連續性
3. 如有必要，手動在編輯界面中增加中間點位

#### 問題：通訊點無法正確投影到路徑
**原因**：通訊點座標與軌跡路徑距離過遠
**解決方案**：
1. 檢查通訊點 TXT 檔案中的座標精確性
2. 使用編輯界面手動調整通訊點位置
3. 確認 GPX 軌跡涵蓋所有通訊點區域

### 網頁界面問題

#### 問題：地圖無法顯示或載入緩慢
**原因**：網路連線問題或 Leaflet 地圖服務異常
**解決方案**：
1. 確認網路連線正常
2. 嘗試重新整理頁面
3. 檢查瀏覽器開發者工具中的錯誤訊息

#### 問題：檔案下載功能無效
**原因**：瀏覽器安全政策或檔案格式問題
**解決方案**：
1. 確認瀏覽器允許檔案下載
2. 檢查彈跳視窗封鎖設定
3. 嘗試使用不同的瀏覽器

### 程式執行問題

#### 問題：Python 程式執行錯誤
**原因**：缺少必要的 Python 套件或版本不相容
**解決方案**：
1. 確認 Python 版本為 3.7 以上
2. 安裝所需套件：`pip install gpxpy pandas geopandas shapely haversine`
3. 檢查檔案路徑和權限設定

#### 問題：處理結果資料夾為空
**原因**：輸入檔案格式錯誤或檔案路徑問題
**解決方案**：
1. 確認 `data_raw/` 資料夾結構正確
2. 檢查 GPX 和 TXT 檔案格式是否符合規範
3. 查看程式執行過程中的錯誤訊息
